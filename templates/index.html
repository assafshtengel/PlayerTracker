<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת מעקב שחקנים</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>
<body>
    <header>
        <h1>אסף שטנגל - מאמן מנטלי לשחקנים</h1>
    </header>
    <h1>ברוך הבא למערכת מעקב שחקנים</h1>

    <!-- שלב מילוי שם משתמש, קבוצה ותפקיד -->
    <div id="user-input-container" class="game-info-container">
        <h2>ברוך הבא! הזן פרטים להתחלת המשחק</h2>
        <div class="input-group">
            <input type="text" id="player-name" placeholder="הכנס שם שחקן" />
            <input type="text" id="team-name" placeholder="הכנס שם הקבוצה היריבה" />
            <select id="player-position">
                <option value="" disabled selected>בחר תפקיד</option>
                <option value="שוער">שוער</option>
                <option value="בלם">בלם</option>
                <option value="מגן">מגן</option>
                <option value="קשר">קשר</option>
                <option value="חלוץ">חלוץ</option>
            </select>
        </div>
        <button id="submit-user-info" onclick="submitUserInfo()">אישור</button>
    </div>

    <!-- מידע על שם, קבוצה ותפקיד -->
    <div id="game-info" class="hidden game-info-container">
        <h2><span id="player-display"></span></h2>
        <h3>מול <span id="team-display"></span></h3>
        <p>תפקיד: <span id="player-position-display"></span></p>
        <p>תאריך המשחק: <span id="game-date"></span></p>
    </div>

    <!-- בחירת פעולות לפי תפקיד -->
    <div class="game-info-container hidden" id="actions-selection-container">
        <h3>בחר פעולות לתפקיד</h3>
        <div id="actions-list">
            <!-- הפעולות ייטענו כאן דינמית -->
        </div>
        <button onclick="confirmActions()">אשר בחירה</button>
    </div>

    <!-- כפתור תחילת המשחק -->
    <div id="start-game-container" class="hidden">
        <button id="start-game" class="start-game-btn" onclick="startGame()">תחילת משחק</button>
    </div>

    <!-- תצוגת זמן המשחק -->
    <div id="game-timer" class="hidden">
        <p>דקה: <span id="minute-counter">0</span></p>
    </div>

    <!-- כותרת פעולות -->
    <p class="hidden" id="actions-title">בחר את הפעולות שהשחקן מבצע במהלך המשחק:</p>

    <!-- תצוגת פעולות במהלך המשחק -->
    <div class="actions-grid hidden" id="actions-container">
        <!-- כפתורי הפעולות ייטענו כאן דינמית -->
    </div>

    <!-- כפתורי סיום המשחק -->
    <div id="end-buttons-container" class="hidden">
        <button id="end-half" class="half-time-btn" onclick="endHalfTime()">סיום מחצית</button>
        <button id="end-game" class="end-game-btn" onclick="endGame()">סיים משחק</button>
    </div>

    <!-- Popup עבור הודעות -->
    <div id="popup" class="hidden"></div>

    <!-- Popup לסיכום מחצית זמן -->
    <div id="half-time-summary-popup" class="popup hidden">
        <div class="popup-content">
            <span class="close-btn" onclick="resumeHalf()">&times;</span>
            <div id="half-summary-content"></div>
            <button onclick="resumeHalf()">המשך משחק</button>
        </div>
    </div>

    <!-- Popup לסיכום המשחק -->
    <div id="game-summary-popup" class="popup hidden">
        <div class="popup-content" id="game-summary-content">
            <span class="close-btn" onclick="closePopup()">&times;</span>
            <div id="summary-content">
                <p style="color: blue;">אסף שטנגל - מאמן מנטלי לשחקנים</p>
                <p>שם השחקן: <span id="player-display-summary"></span></p>
                <p>תאריך המשחק: <span id="game-date-summary"></span></p>
                <p>קבוצה יריבה: <span id="team-display-summary"></span></p>
            </div>
            <button id="view-all-actions" class="view-all-btn" onclick="showAllActions()">צפה בכל הפעולות</button>
            <!-- כפתור להורדת נתוני המשחק כ-CSV -->
            <button id="download-csv" class="view-all-btn" onclick="downloadCSV()">הורד נתוני משחק</button>
            <!-- כפתור לצילום מסך של הפופ אפ -->
            <button onclick="takeScreenshot()">צלם מסך</button>
        </div>
    </div>

    <!-- Popup פידבק אישי מותאם לשחקן -->
    <div id="feedback-popup" class="popup hidden">
        <div class="popup-content" id="feedback-content">
            <span class="close-btn" onclick="closeFeedbackPopup()">&times;</span>
            <h3>פידבק אישי לשחקן</h3>
            <p id="feedback-text"></p>
        </div>
    </div>

    <!-- Popup תוצאות המחצית -->
    <div id="half-time-summary-popup" class="popup hidden">
        <div class="popup-content">
            <div id="half-summary-content"></div>
            <button id="resume-half" class="resume-half-btn" onclick="resumeHalf()">חידוש מחצית</button>
            <button id="view-all-actions-half" class="view-all-btn" onclick="showAllActions()">צפה בכל הפעולות</button>
        </div>
    </div>

    <!-- Popup להצגת כל הפעולות -->
    <div id="actions-detail-popup" class="popup hidden">
        <div class="popup-content">
            <span class="close-btn" onclick="closeAllActionsPopup()">&times;</span>
            <h3>כל הפעולות שבוצעו במהלך המשחק:</h3>
            <div id="all-actions-list"></div>
            <button onclick="closeAllActionsPopup()">סגור</button>
        </div>
    </div>

    <!-- Popup כללי -->
    <div id="popup" class="hidden">פעולה נרשמה</div>

    <!-- Popup לבחירת תוצאה -->
    <div id="result-selection-popup" class="popup hidden">
        <div class="popup-content">
            <span class="close-btn" onclick="closeResultSelection()">&times;</span>
            <h3>בחר את תוצאת הפעולה:</h3>
            <button class="result-btn good" onclick="selectResult('מוצלח')">מוצלח</button>
            <button class="result-btn bad" onclick="selectResult('רעה')">רעה</button>
            <button class="result-btn neutral" onclick="selectResult('ניטרלית')">ניטרלית</button>
        </div>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        // פונקציה לצילום מסך של פופאפ הסיכום
        function takeScreenshot() {
            const element = document.getElementById('game-summary-content'); // צלם רק את הפופאפ של סיכום המשחק
            html2canvas(element).then((canvas) => {
                const link = document.createElement('a');
                link.href = canvas.toDataURL();
                link.download = 'game_summary_screenshot.png';
                link.click();
            });
        }

        // פונקציה להורדת נתוני המשחק כקובץ CSV
        function downloadCSV() {
            let csvContent = "data:text/csv;charset=utf-8,פעולה,תוצאה,דקה\n";
            actions.forEach(a => {
                csvContent += `${a.action},${a.result},${a.minute}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "game_summary.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
